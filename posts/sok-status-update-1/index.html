<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Season of KDE Status Update #1 | rohith</title><meta name=keywords content="C++"><meta name=description content="
Introduction
Recently, me and my friend Shivang got selected for KDE&rsquo;s mentorship programme,
Season of KDE 2026.

https://mentorship.kde.org/blog/2026-01-21-sok-26-welcome/#implement-font-subsetting-when-saving-files-in-okular
Our proposal included implementing font subsetting in their PDF reader, Okular.
A Brief Overview of Fonts
Font files are of many extensions; the most common ones include TrueType (.ttf) and OpenType (.otf) which are binary files containing
data organized in specific tables.
Both of which are really similar (they both share the same structure involving tables for storing certain types of data). They primarily
differ in the fact that TrueType uses quadratic Bézier curves while OpenType uses
cubic ones."><meta name=author content><link rel=canonical href=https://rohith.net/posts/sok-status-update-1/><link crossorigin=anonymous href=/assets/css/stylesheet.e82155c7247afa1c78bbd44b43fab75c36ce707594f71ed245e04bb2661a3be2.css integrity="sha256-6CFVxyR6+hx4u9RLQ/q3XDbOcHWU9x7SReBLsmYaO+I=" rel="preload stylesheet" as=style><link rel=icon href=https://raw.githubusercontent.com/rv178/website/main/static/favicon.png><link rel=icon type=image/png sizes=16x16 href=https://raw.githubusercontent.com/rv178/website/main/static/favicon.png><link rel=icon type=image/png sizes=32x32 href=https://raw.githubusercontent.com/rv178/website/main/static/favicon.png><link rel=apple-touch-icon href=https://raw.githubusercontent.com/rv178/website/main/static/favicon.png><link rel=mask-icon href=https://raw.githubusercontent.com/rv178/website/main/static/favicon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://rohith.net/posts/sok-status-update-1/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.css integrity=sha384-5TcZemv2l/9On385z///+d7MSYlvIEw9FuZTIdZ14vJLqWphw7e7ZPuOiCHJcFCP crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.js integrity=sha384-cMkvdD8LoxVzGF/RPUKAcvmm49FQ0oxwDF3BGKtDXcEc+T1b2N+teh/OJfpU0jr6 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/contrib/auto-render.min.js integrity=sha384-hCXGrW6PitJEwbkoStFjeJxv+fSOOQKOPbJxSfM6G5sWZjAyWhXiTIIAmQqnlLlh crossorigin=anonymous onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><meta property="og:title" content="Season of KDE Status Update #1"><meta property="og:description" content="
Introduction
Recently, me and my friend Shivang got selected for KDE&rsquo;s mentorship programme,
Season of KDE 2026.

https://mentorship.kde.org/blog/2026-01-21-sok-26-welcome/#implement-font-subsetting-when-saving-files-in-okular
Our proposal included implementing font subsetting in their PDF reader, Okular.
A Brief Overview of Fonts
Font files are of many extensions; the most common ones include TrueType (.ttf) and OpenType (.otf) which are binary files containing
data organized in specific tables.
Both of which are really similar (they both share the same structure involving tables for storing certain types of data). They primarily
differ in the fact that TrueType uses quadratic Bézier curves while OpenType uses
cubic ones."><meta property="og:type" content="article"><meta property="og:url" content="https://rohith.net/posts/sok-status-update-1/"><meta property="og:image" content="https://rohith.net/posts/sok-status-update-1/cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2026-02-01T21:47:43+05:30"><meta property="article:modified_time" content="2026-02-01T21:47:43+05:30"><meta property="og:site_name" content="rohith"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://rohith.net/posts/sok-status-update-1/cover.png"><meta name=twitter:title content="Season of KDE Status Update #1"><meta name=twitter:description content="
Introduction
Recently, me and my friend Shivang got selected for KDE&rsquo;s mentorship programme,
Season of KDE 2026.

https://mentorship.kde.org/blog/2026-01-21-sok-26-welcome/#implement-font-subsetting-when-saving-files-in-okular
Our proposal included implementing font subsetting in their PDF reader, Okular.
A Brief Overview of Fonts
Font files are of many extensions; the most common ones include TrueType (.ttf) and OpenType (.otf) which are binary files containing
data organized in specific tables.
Both of which are really similar (they both share the same structure involving tables for storing certain types of data). They primarily
differ in the fact that TrueType uses quadratic Bézier curves while OpenType uses
cubic ones."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://rohith.net/posts/"},{"@type":"ListItem","position":2,"name":"Season of KDE Status Update #1","item":"https://rohith.net/posts/sok-status-update-1/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Season of KDE Status Update #1","name":"Season of KDE Status Update #1","description":" Introduction Recently, me and my friend Shivang got selected for KDE\u0026rsquo;s mentorship programme, Season of KDE 2026.\nhttps://mentorship.kde.org/blog/2026-01-21-sok-26-welcome/#implement-font-subsetting-when-saving-files-in-okular\nOur proposal included implementing font subsetting in their PDF reader, Okular.\nA Brief Overview of Fonts Font files are of many extensions; the most common ones include TrueType (.ttf) and OpenType (.otf) which are binary files containing data organized in specific tables.\nBoth of which are really similar (they both share the same structure involving tables for storing certain types of data). They primarily differ in the fact that TrueType uses quadratic Bézier curves while OpenType uses cubic ones.\n","keywords":["C++"],"articleBody":" Introduction Recently, me and my friend Shivang got selected for KDE’s mentorship programme, Season of KDE 2026.\nhttps://mentorship.kde.org/blog/2026-01-21-sok-26-welcome/#implement-font-subsetting-when-saving-files-in-okular\nOur proposal included implementing font subsetting in their PDF reader, Okular.\nA Brief Overview of Fonts Font files are of many extensions; the most common ones include TrueType (.ttf) and OpenType (.otf) which are binary files containing data organized in specific tables.\nBoth of which are really similar (they both share the same structure involving tables for storing certain types of data). They primarily differ in the fact that TrueType uses quadratic Bézier curves while OpenType uses cubic ones.\nAlso, TrueType was developed by Apple in the late 80s and OpenType was developed by Microsoft and Adobe. It was derived from the original TrueType format and is able to contain both TrueType and PostScript data.\nThis awesome YouTube video covers the history of fonts really well, starting from bitmaps and going all the way upto vector fonts. Also, Sebastian Lague’s video on fonts helped a lot to understand the format of TTF files. I highly suggest giving it a watch!\nHere are some of the important tables in TTF/OTF formats relevant to font subsetting:\nName Purpose glyf Stores visual outlines of the characters. loca Contains the addresses to the relevant glyphs from the glyf table. cmap Maps unicode value (like U+0042 for ‘B’) to a glyph ID. hmtx Stores the width of the character and the amount of whitespace to the left of it. head Global font header (contains info about the font’s version etc.) and its checksum. One thing to note is that in TTF files there are simple glyphs (like a) and composite glyphs (like é) formed by combining multiple simple glyphs.\nSide note: hmtx is different from kerning (which uses the kern table) because hmtx defines how much width the character actually takes up and the left side bearing (initial space) while kerning defines how much space there is between two characters. Kerning takes priority when specific characters are grouped together to make it look more natural (like “AV” or “To”).\nAnyhow, we are getting a bit sidetracked as most of the actual font (and by extension, subsetting) logic is abstracted away by the use of the HarfBuzz API.\nWhat is Font Subsetting? Font subsetting includes stripping away unused characters from a bigger, original font file and essentially creating a subset of only the characters needed.\nFor example, a JetBrainsMono-Regular.ttf downloaded from their website is almost 114 kb. A trimmed down version of this font file subsetted for the string “hello” (so it only contains h, e, l and o) is around 1.7 kb.\nHow is this relevant to a PDF reader?\nWhen new text annotations are added in Okular, the whole font file is embedded into the PDF which makes the PDF file size huge (especially for fonts that contain a lot of glyphs). Font subsetting completely mitigates this issue by reducing the size of the embedded font file.\nWhile the proposal implies font subsetting in Okular, most of the work is to be done in Poppler, the PDF backend and rendering engine which Okular uses.\nExample Subsetting Function (using HarfBuzz) After a lot of planning, we decided to use the hb and hb-subset APIs provided by HarfBuzz.\nHere’s an example function subset_font() which takes in an input file path, an output file path and the text to generate the subsetted font file.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 #include #include // for hb_font_t and hb_shape void subset_font(const char *in, const char *out, const std::string \u0026text) { // map the font file on disk into a HarfBuzz blob on memory hb_blob_t *blob = hb_blob_create_from_file(in); // new face object from the blob hb_face_t *face = hb_face_create(blob, 0); // new font object from specified face hb_font_t *font = hb_font_create(face); // new subset input object (fails if hb-subset is missing) hb_subset_input_t *input = hb_subset_input_create_or_fail(); // hold the input text and its properties before shaping hb_buffer_t *buf = hb_buffer_create(); // retain GID mappings hb_subset_input_set_flags(input, HB_SUBSET_FLAGS_RETAIN_GIDS); // shape text directly to GIDs hb_buffer_add_utf8(buf, text.c_str(), -1, 0, -1); hb_buffer_guess_segment_properties(buf); hb_shape(font, buf, nullptr, 0); // add GIDs to the subset input unsigned int count; hb_glyph_info_t *info = hb_buffer_get_glyph_infos(buf, \u0026count); for (unsigned int i = 0; i \u003c count; i++) hb_set_add(hb_subset_input_glyph_set(input), info[i].codepoint); // generate a subsetted font file and save on disk if (hb_face_t *s_face = hb_subset_or_fail(face, input)) { hb_blob_t *res = hb_face_reference_blob(s_face); unsigned int len; const char *data = hb_blob_get_data(res, \u0026len); if (FILE *f = fopen(out, \"wb\")) { fwrite(data, 1, len, f); fclose(f); } hb_blob_destroy(res); hb_face_destroy(s_face); } // cleanup hb_buffer_destroy(buf); hb_font_destroy(font); hb_subset_input_destroy(input); hb_face_destroy(face); hb_blob_destroy(blob); } Explaining the HarfBuzz types hb_blob_t: From the HarfBuzz manual:\nData type for blobs. A blob wraps a chunk of binary data and facilitates its lifecycle management between a client program and HarfBuzz.\nA blob is a wrapper for raw binary data (in this case, the font file). This abstracts away the memory management aspect of loading the data, as in, parts of the font file can be lazy loaded as required.\nhb_face_t: From the HarfBuzz manual:\nA font face can be created from a binary blob using hb_face_create(). The face index is used to select a face from a binary blob that contains multiple faces. For example, a binary blob that contains both a regular and a bold face can be used to create two font faces, one for each face index.\n1 hb_face_t *face = hb_face_create(blob, 0); Here, the blob is passed as the first argument and the second argument is the faceIndex. Since we’re only dealing with .ttf files here, we can safely pass the face index as 0. However this would differ for font collections (.ttc files).\n1 2 3 4 5 6 7 8 Single Font File (.ttf): Font Collection (.ttc): _______________________ ________________________ | | | | | faceIndex=0 | | faceIndex=0: Regular | | (only one) | | faceIndex=1: Bold | |_______________________| | faceIndex=2: Italic | |________________________| hb_font_t: From the HarfBuzz manual:\nData type for holding fonts.\nAn hb_font_t is essentially an hb_face_t with added instance parameters like scale, PPEM (pixels per EM), PTEM (points per EM) and variations (eg: Weight=700, Width=120 etc.).\nhb_subset_input_t: From the HarfBuzz manual:\nThings that change based on the input. Characters to keep, etc.\nhb_buffer_t: From the HarfBuzz manual:\nThe main structure holding the input text and its properties before shaping, and output glyphs and their information after shaping.\nThis object eventually contains the string of unicode characters from the inputted text (which then gets used to generate the subsetted font). After shaping, (hb_shape()), the buffer holds the glyph IDs and other glyph data.\nRetaining GID mappings HarfBuzz provides a flag which can be set to avoid remapping the glyph IDs of the characters in the subsetted file.\n1 hb_subset_input_set_flags(input, HB_SUBSET_FLAGS_RETAIN_GIDS); From the HarfBuzz manual:\nHB_SUBSET_FLAGS_RETAIN_GIDS If set glyph indices will not be modified in the produced subset. If glyphs are dropped their indices will be retained as an empty glyph. Remember the cmap table from earlier? Because the GIDs (glyph IDs) have changed, it must be rebuilt so that the unicode codepoints point to new, lower indices.\nPassing this flag enables us to retain the original GIDs. Poppler’s code internally requires the GIDs to not be remapped (more on this later). However, there is a caveat to this.\nHere’s an example:\nBelow is a comparison of two different subsetted TTF files from a JetBrainsMono-Regular TTF file, with the retain GID mappings flag enabled for test1.ttf and disabled for test.ttf, for the string “hello”.\nNotice the difference in the number of glyphs: However, both of them contain the exact same number of characters: This is because when retaining the GID mappings, HarfBuzz “pads” the file with a bunch of empty glyphs. Hence the output font file size is comparatively bigger.\nConfiguring the development environment Setting up kde-builder After looking into the process of developing KDE applications, we found out that KDE provides their own build automation tool called kdesrc-build.\nHowever, this ended up being a dead end as after finishing all the setup, we found out about kde-builder (the official successor and reimplementation of kdesrc-build).\nAfter setting up the tool, we also configured Okular and Poppler to use custom source directories:\nIn ~/.config/kde-builder.yaml:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 project poppler: repository: \"\" no-src: true source-dir: \"\" cmake-options: \u003e -DCMAKE_BUILD_TYPE=RelWithDebInfo -DBUILD_GTK_TESTS=OFF -DBUILD_QT5_TESTS=OFF -DBUILD_QT6_TESTS=OFF -DBUILD_CPP_TESTS=OFF -DENABLE_UTILS=OFF -DENABLE_CPP=OFF -DENABLE_GLIB=OFF -DENABLE_QT5=OFF -DENABLE_QT6=ON override okular: no-src: true source-dir: \"\" Both of us faced an issue with the documentation checker when we were trying to compile Wayland. This got fixed with:\n1 2 override wayland: meson-options: \"-Ddocumentation=false\" 1 2 3 4 5 6 7 kde-builder poppler # building poppler for the first time kde-builder okular # building okular for the first time kde-builder --run okular # running okular kde-builder poppler --no-include-dependencies # subsequent poppler builds kde-builder okular --no-include-dependencies # subsequent okular builds Setting up gdb Shivang ended up configuring GDB (GNU Debugger) to be used with Okular and Poppler for better debugging.\nThe following steps were taken:\n1. Changing the cmake-options in kde-builder.yaml from DCMAKE_BUILD_TYPE=RelWithDebInfo to DCMAKE_BUILD_TYPE=Debug.\n2. Forcing a rebuild of Poppler:\n1 kde-builder poppler --refresh-build --no-include-dependencies 3. source ~/kde/build/prefix.sh for loading all the required environment variables.\n4. Running gdb okular.\nLinking the HarfBuzz library in Poppler Since Poppler uses CMake as its build system, I edited CMakeLists.txt to include HarfBuzz as a dependency to enable the use of header files like hb.h and hb-subset.h.\n1 pkg_check_modules(HARFBUZZ REQUIRED harfbuzz\u003e=2.0.0 harfbuzz-subset) 1 2 3 4 5 set(poppler_LIBS Freetype::Freetype ZLIB::ZLIB ${HARFBUZZ_LIBRARIES} ) 1 target_include_directories(poppler SYSTEM PRIVATE ${HARFBUZZ_INCLUDE_DIRS}) Poppler Integration Relevant Commits Shivang ended up finding the relevant commits related to font embedding in the commit history:\nAnnotations: Make sure we embed fonts for the FreeText annots\nSignatures: Make sure we embed the needed fonts\nForms: Make sure we embedd fonts as needed\nPoppler also contains support for stream compression (to compress font streams in forms), added in this commit.\nRelevant Functions We narrowed down the relevant functions as follows:\nIn poppler/GlobalParams.cc: findSystemFontFileForChar() searches the computer for a font which contains a specific glyph for a character. findSystemFontFileForFamilyAndStyle() finds a font on the computer based on the requested font family and style. supportedFontForEmbedding() checks if the found font type is TrueType (.ttf), TrueType Collection (.ttc), or OpenType (.otf) since those are the only font file types supported by Poppler. In poppler/Form.cc: addFontToDefaultResources() takes the font file as a parameter and embeds it into the PDF’s resources. ensureFontsForAllCharacters() checks whether all the relevant characters in the PDF can be displayed by the current font. If not, it starts the font embedding process once again. findFontInDefaultResources() searches for a specific font within a PDF form’s default resource dictionary and returns its internal resource name (key) if found. Side note: The default resource dictionary (denoted as /DR) holds the technical definitions for everything the PDF viewer needs to display form data consistently.\nIn poppler/Annot.cc: The type AnnotText handles all the sticky notes. However this is not relevant to us as the system handles the font here. AnnotFreeText handles text typed directly on the page. It includes complex text layouting (layoutText()) to wrap lines and also includes the ability to choose fonts. So for all AnnotFreeText objects, we need to intercept the font stream before it gets embedded into the PDF and then subset it.\nSubsetting the font data in addFontToDefaultResources() [ WIP ]\nCurrent Implementation (Font Embedding Into Global Resource) When the user creates an annotation, selects a font (eg. Arial) and clicks apply, Poppler does two things:\nIt checks the PDF’s global /Resources dictionary. If the font is not there, it takes the font data and writes it to the global resource. Poppler then uses the font stored in the global resource to render the characters on the screen.\nThe appended font is not subsetted. If it were, when the user adds the next annotation, and if the annotation contains characters that are not in the appended font file, then the text would fail to render.\nProposed Implementation (Subsetted Font Embedding Into Annotation’s Local Resource) Here, we modify the process to append the subsetted font file to the annotation’s local resource instead of the PDF’s global resource.\nWe aim to make it such that the process happens in four steps:\nWhen the user selects the font and clicks apply, the entire font file gets appended into the annotation’s local resource. As the user adds or delete characters, the full font file gets used to prevent any missing glyphs. When the user saves the PDF, we scan the annotation’s text and pass it into the subsetting function which outputs the embedded font file subsetted for that specific string. The original font file is deleted from the annotation’s local resource and replaced with the subsetted font file. References [ Will add once draft is complete ]\n","wordCount":"2190","inLanguage":"en","image":"https://rohith.net/posts/sok-status-update-1/cover.png","datePublished":"2026-02-01T21:47:43+05:30","dateModified":"2026-02-01T21:47:43+05:30","mainEntityOfPage":{"@type":"WebPage","@id":"https://rohith.net/posts/sok-status-update-1/"},"publisher":{"@type":"Organization","name":"rohith","logo":{"@type":"ImageObject","url":"https://raw.githubusercontent.com/rv178/website/main/static/favicon.png"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><ul id=menu><li><a href=https://rohith.net/ title=Home><span>Home</span></a></li><li><a href=https://rohith.net/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://rohith.net/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://rohith.net/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul><div class=logo><a href=https://rohith.net/ accesskey=h title="  (Alt + H)"></a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)">
<svg id="moon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch></ul></div></div></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://rohith.net/>Home</a>&nbsp;»&nbsp;<a href=https://rohith.net/posts/>Posts</a></div><h1 class=post-title>Season of KDE Status Update #1<sup><span class=entry-isdraft>&nbsp;&nbsp;[draft]</span></sup></h1><div class=post-meta><span title='2026-02-01 21:47:43 +0530 +0530'>February 1, 2026</span>&nbsp;·&nbsp;11 min&nbsp;·&nbsp;2190 words</div></header><figure class=entry-cover><img loading=lazy srcset="https://rohith.net/posts/sok-status-update-1/cover_hu_3eb421f5dc449178.png 360w ,https://rohith.net/posts/sok-status-update-1/cover_hu_214af7b3c690890e.png 480w ,https://rohith.net/posts/sok-status-update-1/cover_hu_432d320ff8afe7d5.png 720w ,https://rohith.net/posts/sok-status-update-1/cover.png 1000w" sizes="(min-width: 768px) 720px, 100vw" src=https://rohith.net/posts/sok-status-update-1/cover.png alt=Cover width=1000 height=180><p>We are so back</p></figure><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a><ul><li><a href=#a-brief-overview-of-fonts>A Brief Overview of Fonts</a></li><li><a href=#what-is-font-subsetting>What <em>is</em> Font Subsetting?</a></li></ul></li><li><a href=#example-subsetting-function-using-harfbuzz>Example Subsetting Function (using HarfBuzz)</a><ul><li><a href=#explaining-the-harfbuzz-types>Explaining the HarfBuzz types</a></li><li><a href=#retaining-gid-mappings>Retaining GID mappings</a></li></ul></li><li><a href=#configuring-the-development-environment>Configuring the development environment</a><ul><li><a href=#setting-up-kde-builder>Setting up <code>kde-builder</code></a></li><li><a href=#setting-up-gdb>Setting up <code>gdb</code></a></li><li><a href=#linking-the-harfbuzz-library-in-poppler>Linking the HarfBuzz library in Poppler</a></li></ul></li><li><a href=#poppler-integration>Poppler Integration</a><ul><li><a href=#relevant-commits>Relevant Commits</a></li><li><a href=#relevant-functions>Relevant Functions</a></li><li><a href=#subsetting-the-font-data-in-addfonttodefaultresources>Subsetting the font data in <code>addFontToDefaultResources()</code></a></li><li><a href=#current-implementation-font-embedding-into-global-resource>Current Implementation (Font Embedding Into Global Resource)</a></li><li><a href=#proposed-implementation-subsetted-font-embedding-into-annotations-local-resource>Proposed Implementation (Subsetted Font Embedding Into Annotation&rsquo;s Local Resource)</a></li></ul></li><li><a href=#references>References</a></li></ul></nav></div></details></div><div class=post-content><hr><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h2><p>Recently, me and my friend <a href=https://github.com/shivkr6/>Shivang</a> got selected for KDE&rsquo;s mentorship programme,
<a href=https://mentorship.kde.org/sok/>Season of KDE</a> 2026.</p><blockquote><p><a href=https://mentorship.kde.org/blog/2026-01-21-sok-26-welcome/#implement-font-subsetting-when-saving-files-in-okular>https://mentorship.kde.org/blog/2026-01-21-sok-26-welcome/#implement-font-subsetting-when-saving-files-in-okular</a></p></blockquote><p>Our proposal included implementing font subsetting in their PDF reader, <a href=https://okular.kde.org/>Okular</a>.</p><h3 id=a-brief-overview-of-fonts>A Brief Overview of Fonts<a hidden class=anchor aria-hidden=true href=#a-brief-overview-of-fonts>#</a></h3><p>Font files are of many extensions; the most common ones include TrueType <em>(.ttf)</em> and OpenType <em>(.otf)</em> which are binary files containing
data organized in specific tables.</p><p>Both of which are really similar (they both share the same structure involving tables for storing certain types of data). They primarily
differ in the fact that TrueType uses quadratic <a href=https://en.wikipedia.org/wiki/B%C3%A9zier_curve>Bézier curves</a> while OpenType uses
cubic ones.</p><p>Also, TrueType was developed by Apple in the late 80s and OpenType was developed by Microsoft and Adobe. It was derived from the original
TrueType format and is able to contain both TrueType and PostScript data.</p><p>This <a href="https://youtu.be/BfEvIjTQkIE?si=GSV6CbWuBMePFYnc">awesome YouTube video</a> covers the history of fonts really well, starting from bitmaps
and going all the way upto vector fonts. Also, <a href="https://www.youtube.com/watch?v=SO83KQuuZvg">Sebastian Lague&rsquo;s video on fonts</a> helped a lot
to understand the format of TTF files. I highly suggest giving it a watch!</p><p>Here are some of the important tables in TTF/OTF formats relevant to font subsetting:</p><table><thead><tr><th>Name</th><th>Purpose</th></tr></thead><tbody><tr><td><code>glyf</code></td><td>Stores visual outlines of the characters.</td></tr><tr><td><code>loca</code></td><td>Contains the addresses to the relevant glyphs from the <code>glyf</code> table.</td></tr><tr><td><code>cmap</code></td><td>Maps unicode value (like <code>U+0042</code> for &lsquo;B&rsquo;) to a glyph ID.</td></tr><tr><td><code>hmtx</code></td><td>Stores the width of the character and the amount of whitespace to the left of it.</td></tr><tr><td><code>head</code></td><td>Global font header (contains info about the font&rsquo;s version etc.) and its checksum.</td></tr></tbody></table><p>One thing to note is that in TTF files there are simple glyphs (like <code>a</code>) and composite glyphs (like <code>é</code>) formed by combining multiple
simple glyphs.</p><p>Side note: <code>hmtx</code> is different from kerning (which uses the <code>kern</code> table) because <code>hmtx</code> defines how much width the character actually takes up
and the left side bearing (initial space) while kerning defines how much space there is between <em>two</em> characters. Kerning takes priority
when specific characters are grouped together to make it look more natural (like &ldquo;AV&rdquo; or &ldquo;To&rdquo;).</p><p>Anyhow, we are getting a bit sidetracked as most of the actual font (and by extension, subsetting) logic is abstracted away by the use
of the <a href=https://harfbuzz.github.io/>HarfBuzz</a> API.</p><h3 id=what-is-font-subsetting>What <em>is</em> Font Subsetting?<a hidden class=anchor aria-hidden=true href=#what-is-font-subsetting>#</a></h3><p>Font subsetting includes stripping away unused characters from a bigger, original font file and essentially creating a subset of <em>only</em> the
characters needed.</p><p>For example, a <code>JetBrainsMono-Regular.ttf</code> downloaded from their website is almost <code>114 kb</code>. A trimmed down version of this font file
subsetted for the string &ldquo;hello&rdquo; (so it only contains <code>h</code>, <code>e</code>, <code>l</code> and <code>o</code>) is around <code>1.7 kb</code>.</p><p>How is this relevant to a PDF reader?</p><p>When new text annotations are added in Okular, the whole font file is embedded into the PDF which makes the PDF file size huge (especially for
fonts that contain a lot of glyphs). Font subsetting completely mitigates this issue by reducing the size of the embedded font file.</p><p>While the proposal implies font subsetting in Okular, most of the work is to be done in <a href=https://poppler.freedesktop.org/>Poppler</a>, the
PDF backend and rendering engine which Okular uses.</p><h2 id=example-subsetting-function-using-harfbuzz>Example Subsetting Function (using HarfBuzz)<a hidden class=anchor aria-hidden=true href=#example-subsetting-function-using-harfbuzz>#</a></h2><p>After a lot of planning, we decided to use the <code>hb</code> and <a href=https://harfbuzz.github.io/harfbuzz-hb-subset.html>hb-subset</a> APIs provided by HarfBuzz.</p><p>Here&rsquo;s an example function <code>subset_font()</code> which takes in an <em>input</em> file path, an <em>output</em> file path and the text to generate the subsetted font
file.</p><div class=highlight><div style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">50
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#5e81ac;font-style:italic>#include</span> <span style=color:#5e81ac;font-style:italic>&lt;hb-subset.h&gt;</span><span style=color:#5e81ac;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#5e81ac;font-style:italic>#include</span> <span style=color:#5e81ac;font-style:italic>&lt;hb.h&gt;</span><span style=color:#5e81ac;font-style:italic> </span><span style=color:#616e87;font-style:italic>// for hb_font_t and hb_shape
</span></span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#81a1c1>void</span> <span style=color:#88c0d0>subset_font</span><span style=color:#eceff4>(</span><span style=color:#81a1c1;font-weight:700>const</span> <span style=color:#81a1c1>char</span> <span style=color:#81a1c1>*</span>in<span style=color:#eceff4>,</span> <span style=color:#81a1c1;font-weight:700>const</span> <span style=color:#81a1c1>char</span> <span style=color:#81a1c1>*</span>out<span style=color:#eceff4>,</span> <span style=color:#81a1c1;font-weight:700>const</span> std<span style=color:#81a1c1>::</span>string <span style=color:#81a1c1>&amp;</span>text<span style=color:#eceff4>)</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>  <span style=color:#616e87;font-style:italic>// map the font file on disk into a HarfBuzz blob on memory
</span></span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic></span>  hb_blob_t <span style=color:#81a1c1>*</span>blob <span style=color:#81a1c1>=</span> hb_blob_create_from_file<span style=color:#eceff4>(</span>in<span style=color:#eceff4>);</span>
</span></span><span style=display:flex><span>  <span style=color:#616e87;font-style:italic>// new face object from the blob
</span></span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic></span>  hb_face_t <span style=color:#81a1c1>*</span>face <span style=color:#81a1c1>=</span> hb_face_create<span style=color:#eceff4>(</span>blob<span style=color:#eceff4>,</span> <span style=color:#b48ead>0</span><span style=color:#eceff4>);</span>
</span></span><span style=display:flex><span>  <span style=color:#616e87;font-style:italic>// new font object from specified face
</span></span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic></span>  hb_font_t <span style=color:#81a1c1>*</span>font <span style=color:#81a1c1>=</span> hb_font_create<span style=color:#eceff4>(</span>face<span style=color:#eceff4>);</span>
</span></span><span style=display:flex><span>  <span style=color:#616e87;font-style:italic>// new subset input object (fails if hb-subset is missing)
</span></span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic></span>  hb_subset_input_t <span style=color:#81a1c1>*</span>input <span style=color:#81a1c1>=</span> hb_subset_input_create_or_fail<span style=color:#eceff4>();</span>
</span></span><span style=display:flex><span>  <span style=color:#616e87;font-style:italic>// hold the input text and its properties before shaping
</span></span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic></span>  hb_buffer_t <span style=color:#81a1c1>*</span>buf <span style=color:#81a1c1>=</span> hb_buffer_create<span style=color:#eceff4>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#616e87;font-style:italic>// retain GID mappings
</span></span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic></span>  hb_subset_input_set_flags<span style=color:#eceff4>(</span>input<span style=color:#eceff4>,</span> HB_SUBSET_FLAGS_RETAIN_GIDS<span style=color:#eceff4>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#616e87;font-style:italic>// shape text directly to GIDs
</span></span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic></span>  hb_buffer_add_utf8<span style=color:#eceff4>(</span>buf<span style=color:#eceff4>,</span> text<span style=color:#eceff4>.</span>c_str<span style=color:#eceff4>(),</span> <span style=color:#81a1c1>-</span><span style=color:#b48ead>1</span><span style=color:#eceff4>,</span> <span style=color:#b48ead>0</span><span style=color:#eceff4>,</span> <span style=color:#81a1c1>-</span><span style=color:#b48ead>1</span><span style=color:#eceff4>);</span>
</span></span><span style=display:flex><span>  hb_buffer_guess_segment_properties<span style=color:#eceff4>(</span>buf<span style=color:#eceff4>);</span>
</span></span><span style=display:flex><span>  hb_shape<span style=color:#eceff4>(</span>font<span style=color:#eceff4>,</span> buf<span style=color:#eceff4>,</span> <span style=color:#81a1c1;font-weight:700>nullptr</span><span style=color:#eceff4>,</span> <span style=color:#b48ead>0</span><span style=color:#eceff4>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#616e87;font-style:italic>// add GIDs to the subset input
</span></span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic></span>  <span style=color:#81a1c1>unsigned</span> <span style=color:#81a1c1>int</span> count<span style=color:#eceff4>;</span>
</span></span><span style=display:flex><span>  hb_glyph_info_t <span style=color:#81a1c1>*</span>info <span style=color:#81a1c1>=</span> hb_buffer_get_glyph_infos<span style=color:#eceff4>(</span>buf<span style=color:#eceff4>,</span> <span style=color:#81a1c1>&amp;</span>count<span style=color:#eceff4>);</span>
</span></span><span style=display:flex><span>  <span style=color:#81a1c1;font-weight:700>for</span> <span style=color:#eceff4>(</span><span style=color:#81a1c1>unsigned</span> <span style=color:#81a1c1>int</span> i <span style=color:#81a1c1>=</span> <span style=color:#b48ead>0</span><span style=color:#eceff4>;</span> i <span style=color:#81a1c1>&lt;</span> count<span style=color:#eceff4>;</span> i<span style=color:#81a1c1>++</span><span style=color:#eceff4>)</span> 
</span></span><span style=display:flex><span>    hb_set_add<span style=color:#eceff4>(</span>hb_subset_input_glyph_set<span style=color:#eceff4>(</span>input<span style=color:#eceff4>),</span> info<span style=color:#eceff4>[</span>i<span style=color:#eceff4>].</span>codepoint<span style=color:#eceff4>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#616e87;font-style:italic>// generate a subsetted font file and save on disk
</span></span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic></span>  <span style=color:#81a1c1;font-weight:700>if</span> <span style=color:#eceff4>(</span>hb_face_t <span style=color:#81a1c1>*</span>s_face <span style=color:#81a1c1>=</span> hb_subset_or_fail<span style=color:#eceff4>(</span>face<span style=color:#eceff4>,</span> input<span style=color:#eceff4>))</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>    hb_blob_t <span style=color:#81a1c1>*</span>res <span style=color:#81a1c1>=</span> hb_face_reference_blob<span style=color:#eceff4>(</span>s_face<span style=color:#eceff4>);</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1>unsigned</span> <span style=color:#81a1c1>int</span> len<span style=color:#eceff4>;</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>const</span> <span style=color:#81a1c1>char</span> <span style=color:#81a1c1>*</span>data <span style=color:#81a1c1>=</span> hb_blob_get_data<span style=color:#eceff4>(</span>res<span style=color:#eceff4>,</span> <span style=color:#81a1c1>&amp;</span>len<span style=color:#eceff4>);</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>if</span> <span style=color:#eceff4>(</span>FILE <span style=color:#81a1c1>*</span>f <span style=color:#81a1c1>=</span> fopen<span style=color:#eceff4>(</span>out<span style=color:#eceff4>,</span> <span style=color:#a3be8c>&#34;wb&#34;</span><span style=color:#eceff4>))</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>      fwrite<span style=color:#eceff4>(</span>data<span style=color:#eceff4>,</span> <span style=color:#b48ead>1</span><span style=color:#eceff4>,</span> len<span style=color:#eceff4>,</span> f<span style=color:#eceff4>);</span>
</span></span><span style=display:flex><span>      fclose<span style=color:#eceff4>(</span>f<span style=color:#eceff4>);</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>    hb_blob_destroy<span style=color:#eceff4>(</span>res<span style=color:#eceff4>);</span>
</span></span><span style=display:flex><span>    hb_face_destroy<span style=color:#eceff4>(</span>s_face<span style=color:#eceff4>);</span>
</span></span><span style=display:flex><span>  <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#616e87;font-style:italic>// cleanup
</span></span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic></span>  hb_buffer_destroy<span style=color:#eceff4>(</span>buf<span style=color:#eceff4>);</span>
</span></span><span style=display:flex><span>  hb_font_destroy<span style=color:#eceff4>(</span>font<span style=color:#eceff4>);</span>
</span></span><span style=display:flex><span>  hb_subset_input_destroy<span style=color:#eceff4>(</span>input<span style=color:#eceff4>);</span>
</span></span><span style=display:flex><span>  hb_face_destroy<span style=color:#eceff4>(</span>face<span style=color:#eceff4>);</span>
</span></span><span style=display:flex><span>  hb_blob_destroy<span style=color:#eceff4>(</span>blob<span style=color:#eceff4>);</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=explaining-the-harfbuzz-types>Explaining the HarfBuzz types<a hidden class=anchor aria-hidden=true href=#explaining-the-harfbuzz-types>#</a></h3><ul><li><h4 id=hb_blob_t><code>hb_blob_t</code>:<a hidden class=anchor aria-hidden=true href=#hb_blob_t>#</a></h4></li></ul><p>From the <a href=https://harfbuzz.github.io/harfbuzz-hb-blob.html#hb-blob-t>HarfBuzz manual</a>:</p><blockquote><p>Data type for blobs. A blob wraps a chunk of binary data and facilitates its lifecycle management between a client program and HarfBuzz.</p></blockquote><p>A blob is a wrapper for raw binary data (in this case, the font file). This abstracts away the memory management aspect of loading the data,
as in, parts of the font file can be lazy loaded as required.</p><ul><li><h4 id=hb_face_t><code>hb_face_t</code>:<a hidden class=anchor aria-hidden=true href=#hb_face_t>#</a></h4></li></ul><p>From the <a href=https://harfbuzz.github.io/harfbuzz-hb-face.html>HarfBuzz manual</a>:</p><blockquote><p>A font face can be created from a binary blob using <code>hb_face_create()</code>. The face index is used to select a face from a binary blob
that contains multiple faces. For example, a binary blob that contains both a regular and a bold face can be used to create two font
faces, one for each face index.</p></blockquote><div class=highlight><div style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>hb_face_t <span style=color:#81a1c1>*</span>face <span style=color:#81a1c1>=</span> hb_face_create<span style=color:#eceff4>(</span>blob<span style=color:#eceff4>,</span> <span style=color:#b48ead>0</span><span style=color:#eceff4>);</span>
</span></span></code></pre></td></tr></table></div></div><p>Here, the blob is passed as the first argument and the second argument is the <code>faceIndex</code>. Since we&rsquo;re only dealing with <strong>.ttf</strong> files here,
we can safely pass the face index as 0. However this would differ for font collections (<strong>.ttc</strong> files).</p><div class=highlight><div style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Single Font File (.ttf):            Font Collection (.ttc):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> _______________________             ________________________
</span></span><span style=display:flex><span>|                       |           |                        |
</span></span><span style=display:flex><span>|      faceIndex=0      |           |  faceIndex=0: Regular  |
</span></span><span style=display:flex><span>|      (only one)       |           |  faceIndex=1: Bold     |
</span></span><span style=display:flex><span>|_______________________|           |  faceIndex=2: Italic   |
</span></span><span style=display:flex><span>                                    |________________________|
</span></span></code></pre></td></tr></table></div></div><ul><li><h4 id=hb_font_t><code>hb_font_t</code>:<a hidden class=anchor aria-hidden=true href=#hb_font_t>#</a></h4></li></ul><p>From the <a href=https://harfbuzz.github.io/harfbuzz-hb-font.html#hb-font-t>HarfBuzz manual</a>:</p><blockquote><p>Data type for holding fonts.</p></blockquote><p>An <code>hb_font_t</code> is essentially an <code>hb_face_t</code> with added instance parameters like scale, <a href=https://learn.microsoft.com/en-us/typography/opentype/spec/ttch01#display-device-characteristics>PPEM (pixels per EM)</a>,
PTEM (points per EM) and variations (eg: Weight=700, Width=120 etc.).</p><ul><li><h4 id=hb_subset_input_t><code>hb_subset_input_t</code>:<a hidden class=anchor aria-hidden=true href=#hb_subset_input_t>#</a></h4></li></ul><p>From the <a href=https://harfbuzz.github.io/harfbuzz-hb-subset.html#hb-subset-input-t>HarfBuzz manual</a>:</p><blockquote><p>Things that change based on the input. Characters to keep, etc.</p></blockquote><ul><li><h4 id=hb_buffer_t><code>hb_buffer_t</code>:<a hidden class=anchor aria-hidden=true href=#hb_buffer_t>#</a></h4></li></ul><p>From the <a href=https://harfbuzz.github.io/harfbuzz-hb-buffer.html#hb-buffer-t>HarfBuzz manual</a>:</p><blockquote><p>The main structure holding the input text and its properties before shaping, and output glyphs and their information after shaping.</p></blockquote><p>This object eventually contains the string of unicode characters from the inputted text (which then gets used to generate the subsetted font).
After shaping, (<code>hb_shape()</code>), the buffer holds the glyph IDs and other glyph data.</p><h3 id=retaining-gid-mappings>Retaining GID mappings<a hidden class=anchor aria-hidden=true href=#retaining-gid-mappings>#</a></h3><p>HarfBuzz provides a flag which can be set to avoid remapping the glyph IDs of the characters in the subsetted file.</p><div class=highlight><div style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>hb_subset_input_set_flags<span style=color:#eceff4>(</span>input<span style=color:#eceff4>,</span> HB_SUBSET_FLAGS_RETAIN_GIDS<span style=color:#eceff4>);</span>
</span></span></code></pre></td></tr></table></div></div><p>From the <a href=https://harfbuzz.github.io/harfbuzz-hb-subset.html#hb-subset-input-set-flags>HarfBuzz manual</a>:</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td><code>HB_SUBSET_FLAGS_RETAIN_GIDS</code></td><td>If set glyph indices will not be modified in the produced subset. If glyphs are dropped their indices will be retained as an empty glyph.</td></tr></tbody></table><p>Remember the <code>cmap</code> table from earlier? Because the GIDs (glyph IDs) have changed, it must be rebuilt so that the unicode codepoints
point to new, lower indices.</p><p>Passing this flag enables us to retain the original GIDs. Poppler&rsquo;s code internally requires the GIDs to <em>not</em> be remapped (more on this
later).
However, there is a caveat to this.</p><p>Here&rsquo;s an example:</p><p>Below is a comparison of two different subsetted TTF files from a <code>JetBrainsMono-Regular</code> TTF file, with the retain GID mappings flag enabled for <code>test1.ttf</code>
and disabled for <code>test.ttf</code>, for the string &ldquo;hello&rdquo;.</p><p>Notice the difference in the number of glyphs:
<img loading=lazy src=2.png alt="Comparison 1"></p><p>However, both of them contain the exact same number of characters:
<img loading=lazy src=1.png alt="Comparison 2"></p><p>This is because when retaining the GID mappings, HarfBuzz &ldquo;pads&rdquo; the file with a bunch of empty glyphs.
Hence the output font file size is comparatively bigger.</p><h2 id=configuring-the-development-environment>Configuring the development environment<a hidden class=anchor aria-hidden=true href=#configuring-the-development-environment>#</a></h2><h3 id=setting-up-kde-builder>Setting up <code>kde-builder</code><a hidden class=anchor aria-hidden=true href=#setting-up-kde-builder>#</a></h3><p>After looking into the process of developing KDE applications, we found out that KDE provides their own build automation tool called
<code>kdesrc-build</code>.</p><p>However, this ended up being a dead end as after finishing all the setup, we found out about <code>kde-builder</code> (the official successor and
reimplementation of <code>kdesrc-build</code>).</p><p>After setting up the tool, we also configured Okular and Poppler to use custom source directories:</p><p>In <code>~/.config/kde-builder.yaml</code>:</p><div class=highlight><div style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#81a1c1>project poppler</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>  <span style=color:#81a1c1>repository</span><span style=color:#eceff4>:</span> <span style=color:#a3be8c>&#34;&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#81a1c1>no-src</span><span style=color:#eceff4>:</span> <span style=color:#81a1c1;font-weight:700>true</span>
</span></span><span style=display:flex><span>  <span style=color:#81a1c1>source-dir</span><span style=color:#eceff4>:</span> <span style=color:#a3be8c>&#34;&lt;path to src dir&gt;&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#81a1c1>cmake-options</span><span style=color:#eceff4>:</span> <span style=color:#eceff4>&gt;</span><span style=color:#616e87>
</span></span></span><span style=display:flex><span><span style=color:#616e87>    -DCMAKE_BUILD_TYPE=RelWithDebInfo
</span></span></span><span style=display:flex><span><span style=color:#616e87>    -DBUILD_GTK_TESTS=OFF
</span></span></span><span style=display:flex><span><span style=color:#616e87>    -DBUILD_QT5_TESTS=OFF
</span></span></span><span style=display:flex><span><span style=color:#616e87>    -DBUILD_QT6_TESTS=OFF
</span></span></span><span style=display:flex><span><span style=color:#616e87>    -DBUILD_CPP_TESTS=OFF
</span></span></span><span style=display:flex><span><span style=color:#616e87>    -DENABLE_UTILS=OFF
</span></span></span><span style=display:flex><span><span style=color:#616e87>    -DENABLE_CPP=OFF
</span></span></span><span style=display:flex><span><span style=color:#616e87>    -DENABLE_GLIB=OFF
</span></span></span><span style=display:flex><span><span style=color:#616e87>    -DENABLE_QT5=OFF
</span></span></span><span style=display:flex><span><span style=color:#616e87>    -DENABLE_QT6=ON</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1>override okular</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>  <span style=color:#81a1c1>no-src</span><span style=color:#eceff4>:</span> <span style=color:#81a1c1;font-weight:700>true</span>
</span></span><span style=display:flex><span>  <span style=color:#81a1c1>source-dir</span><span style=color:#eceff4>:</span> <span style=color:#a3be8c>&#34;&lt;path to src dir&gt;&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>Both of us faced an issue with the documentation checker when we were trying to compile Wayland. This got fixed with:</p><div class=highlight><div style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#81a1c1>override wayland</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>  <span style=color:#81a1c1>meson-options</span><span style=color:#eceff4>:</span> <span style=color:#a3be8c>&#34;-Ddocumentation=false&#34;</span>
</span></span></code></pre></td></tr></table></div></div><hr><div class=highlight><div style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kde-builder poppler <span style=color:#616e87;font-style:italic># building poppler for the first time</span>
</span></span><span style=display:flex><span>kde-builder okular <span style=color:#616e87;font-style:italic># building okular for the first time</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kde-builder --run okular <span style=color:#616e87;font-style:italic># running okular</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kde-builder poppler --no-include-dependencies <span style=color:#616e87;font-style:italic># subsequent poppler builds</span>
</span></span><span style=display:flex><span>kde-builder okular --no-include-dependencies <span style=color:#616e87;font-style:italic># subsequent okular builds</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=setting-up-gdb>Setting up <code>gdb</code><a hidden class=anchor aria-hidden=true href=#setting-up-gdb>#</a></h3><p>Shivang ended up configuring <a href=https://en.wikipedia.org/wiki/GNU_Debugger>GDB (GNU Debugger)</a> to be used with Okular and Poppler for better debugging.</p><p>The following steps were taken:</p><p><strong>1.</strong> Changing the <code>cmake-options</code> in <code>kde-builder.yaml</code> from
<code>DCMAKE_BUILD_TYPE=RelWithDebInfo</code> to <code>DCMAKE_BUILD_TYPE=Debug</code>.</p><p><strong>2.</strong> Forcing a rebuild of Poppler:</p><div class=highlight><div style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kde-builder poppler --refresh-build --no-include-dependencies
</span></span></code></pre></td></tr></table></div></div><p><strong>3.</strong> <code>source ~/kde/build/prefix.sh</code> for loading all the required environment variables.</p><p><strong>4.</strong> Running <code>gdb okular</code>.</p><h3 id=linking-the-harfbuzz-library-in-poppler>Linking the HarfBuzz library in Poppler<a hidden class=anchor aria-hidden=true href=#linking-the-harfbuzz-library-in-poppler>#</a></h3><p>Since Poppler uses <code>CMake</code> as its build system, I edited <code>CMakeLists.txt</code> to include HarfBuzz as a dependency to enable the use of header
files like <code>hb.h</code> and <code>hb-subset.h</code>.</p><div class=highlight><div style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=display:flex><span><span style=color:#81a1c1>pkg_check_modules</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>HARFBUZZ</span> <span style=color:#a3be8c>REQUIRED</span> <span style=color:#a3be8c>harfbuzz&gt;=2.0.0</span> <span style=color:#a3be8c>harfbuzz-subset</span><span style=color:#eceff4>)</span><span style=color:#bf616a>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=display:flex><span><span style=color:#81a1c1>set</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>poppler_LIBS</span> 
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>Freetype::Freetype</span> 
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>ZLIB::ZLIB</span> 
</span></span><span style=display:flex><span>    <span style=color:#81a1c1>${</span>HARFBUZZ_LIBRARIES<span style=color:#81a1c1>}</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>)</span><span style=color:#bf616a>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=display:flex><span><span style=color:#81a1c1>target_include_directories</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>poppler</span> <span style=color:#a3be8c>SYSTEM</span> <span style=color:#a3be8c>PRIVATE</span> <span style=color:#81a1c1>${</span>HARFBUZZ_INCLUDE_DIRS<span style=color:#81a1c1>}</span><span style=color:#eceff4>)</span><span style=color:#bf616a>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=poppler-integration>Poppler Integration<a hidden class=anchor aria-hidden=true href=#poppler-integration>#</a></h2><h3 id=relevant-commits>Relevant Commits<a hidden class=anchor aria-hidden=true href=#relevant-commits>#</a></h3><p>Shivang ended up finding the relevant commits related to font embedding in the commit history:</p><ul><li><p><a href=https://gitlab.freedesktop.org/poppler/poppler/-/commit/5f915d46c99ecbc0c026b86de50f9e0243391a01>Annotations: Make sure we embed fonts for the FreeText annots</a></p></li><li><p><a href=https://gitlab.freedesktop.org/poppler/poppler/-/commit/db7865c6a38dd9d26d8b16ab2727fcec311efad8>Signatures: Make sure we embed the needed fonts</a></p></li><li><p><a href=https://gitlab.freedesktop.org/poppler/poppler/-/commit/0b474ffb990a8285a6d3c2bf157b32b2264fb140>Forms: Make sure we embedd fonts as needed</a></p></li></ul><p>Poppler also contains support for stream compression (to compress font streams in forms), added in <a href=https://gitlab.freedesktop.org/poppler/poppler/-/commit/7d87c7d2c6ca4f814f87329534a17dbf30203313>this</a>
commit.</p><h3 id=relevant-functions>Relevant Functions<a hidden class=anchor aria-hidden=true href=#relevant-functions>#</a></h3><p>We narrowed down the relevant functions as follows:</p><h4 id=in-popplerglobalparamscc>In <code>poppler/GlobalParams.cc</code>:<a hidden class=anchor aria-hidden=true href=#in-popplerglobalparamscc>#</a></h4><ul><li><code>findSystemFontFileForChar()</code> searches the computer for a font which contains a specific glyph for a character.</li><li><code>findSystemFontFileForFamilyAndStyle()</code> finds a font on the computer based on the requested font family and style.</li><li><code>supportedFontForEmbedding()</code> checks if the found font type is TrueType (.ttf), TrueType Collection (.ttc), or OpenType (.otf) since
those are the only font file types supported by Poppler.</li></ul><h4 id=in-popplerformcc>In <code>poppler/Form.cc</code>:<a hidden class=anchor aria-hidden=true href=#in-popplerformcc>#</a></h4><ul><li><code>addFontToDefaultResources()</code> takes the font file as a parameter and embeds it into the PDF&rsquo;s resources.</li><li><code>ensureFontsForAllCharacters()</code> checks whether all the relevant characters in the PDF can be displayed by the current font. If not, it starts
the font embedding process once again.</li><li><code>findFontInDefaultResources()</code> searches for a specific font within a PDF form&rsquo;s default resource dictionary and returns its internal
resource name (key) if found.</li></ul><p><em>Side note: The default resource dictionary (denoted as <code>/DR</code>) holds the technical definitions for everything the PDF viewer needs to
display form data consistently.</em></p><h4 id=in-popplerannotcc>In <code>poppler/Annot.cc</code>:<a hidden class=anchor aria-hidden=true href=#in-popplerannotcc>#</a></h4><ul><li>The type <code>AnnotText</code> handles all the sticky notes. However this is not relevant to us as the system handles the font here.</li><li><code>AnnotFreeText</code> handles text typed directly on the page. It includes complex text layouting (<code>layoutText()</code>) to wrap lines and also
includes the ability to choose fonts.</li></ul><p>So for all <code>AnnotFreeText</code> objects, we need to intercept the font stream before it gets embedded into the PDF and then subset it.</p><h3 id=subsetting-the-font-data-in-addfonttodefaultresources>Subsetting the font data in <code>addFontToDefaultResources()</code><a hidden class=anchor aria-hidden=true href=#subsetting-the-font-data-in-addfonttodefaultresources>#</a></h3><p>[ WIP ]</p><h3 id=current-implementation-font-embedding-into-global-resource>Current Implementation (Font Embedding Into Global Resource)<a hidden class=anchor aria-hidden=true href=#current-implementation-font-embedding-into-global-resource>#</a></h3><p>When the user creates an annotation, selects a font (eg. Arial) and clicks apply, Poppler does two things:</p><ul><li>It checks the PDF&rsquo;s global <code>/Resources</code> dictionary.</li><li>If the font is not there, it takes the font data and writes it to the global resource.</li></ul><p>Poppler then uses the font stored in the global resource to render the characters on the screen.</p><p>The appended font is not subsetted. If it were, when the user adds the next annotation, and if the annotation contains characters that are
not in the appended font file, then the text would fail to render.</p><h3 id=proposed-implementation-subsetted-font-embedding-into-annotations-local-resource>Proposed Implementation (Subsetted Font Embedding Into Annotation&rsquo;s Local Resource)<a hidden class=anchor aria-hidden=true href=#proposed-implementation-subsetted-font-embedding-into-annotations-local-resource>#</a></h3><p>Here, we modify the process to append the subsetted font file to the annotation&rsquo;s local resource instead of the PDF&rsquo;s global resource.</p><p>We aim to make it such that the process happens in four steps:</p><ol><li>When the user selects the font and clicks apply, the entire font file gets appended into the annotation&rsquo;s local resource.</li><li>As the user adds or delete characters, the full font file gets used to prevent any missing glyphs.</li><li>When the user saves the PDF, we scan the annotation&rsquo;s text and pass it into the subsetting function which outputs the embedded font file
subsetted for that specific string.</li><li>The original font file is deleted from the annotation&rsquo;s local resource and replaced with the subsetted font file.</li></ol><h2 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h2><p>[ Will add once draft is complete ]</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://rohith.net/tags/c++/>C++</a></li></ul><nav class=paginav><a class=next href=https://rohith.net/posts/hyperbola-quintessence-in-rust/><span class=title>Next »</span><br><span>Hyperbola Quintessence in Rust</span></a></nav></footer></article></main><footer class=footer><span>Copyright &copy; 2026 <a href=https://rohith.net/>rohith</a></span>
<span>| <a href=https://github.com/rv178/website rel=noopener target=_blank>Source code</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>