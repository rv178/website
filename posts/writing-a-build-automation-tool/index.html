<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Writing a Build Automation Tool | rv178</title><meta name=keywords content="rust,automation,GNU make"><meta name=description content="After using GNU Make for automating the build step in my projects, I had this idea of making my own build automation tool like Make.
I originally wanted to use Makefile-like syntax for the config file but instead settled with TOML after thinking about it for a while. I also used Rust to write this since I am kinda familiar with the language.
Rust has a TOML crate for parsing TOML files."><meta name=author content><link rel=canonical href=https://rv178.is-a.dev/posts/writing-a-build-automation-tool/><link crossorigin=anonymous href=/assets/css/stylesheet.5e8a76e09692b035be261c6e2e26d6f36eecfb72a71a29af1d7cf4131958efb4.css integrity="sha256-Xop24JaSsDW+JhxuLibW827s+3KnGimvHXz0ExlY77Q=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://media.discordapp.net/attachments/765524394017292309/858181434085867570/1624676782371.png><link rel=icon type=image/png sizes=16x16 href=https://media.discordapp.net/attachments/765524394017292309/858181434085867570/1624676782371.png><link rel=icon type=image/png sizes=32x32 href=https://media.discordapp.net/attachments/765524394017292309/858181434085867570/1624676782371.png><link rel=apple-touch-icon href=https://media.discordapp.net/attachments/765524394017292309/858181434085867570/1624676782371.png><link rel=mask-icon href=https://media.discordapp.net/attachments/765524394017292309/858181434085867570/1624676782371.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Writing a Build Automation Tool"><meta property="og:description" content="After using GNU Make for automating the build step in my projects, I had this idea of making my own build automation tool like Make.
I originally wanted to use Makefile-like syntax for the config file but instead settled with TOML after thinking about it for a while. I also used Rust to write this since I am kinda familiar with the language.
Rust has a TOML crate for parsing TOML files."><meta property="og:type" content="article"><meta property="og:url" content="https://rv178.is-a.dev/posts/writing-a-build-automation-tool/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-07-08T15:20:06+05:30"><meta property="article:modified_time" content="2022-07-08T15:20:06+05:30"><meta property="og:site_name" content="rv178"><meta name=twitter:card content="summary"><meta name=twitter:title content="Writing a Build Automation Tool"><meta name=twitter:description content="After using GNU Make for automating the build step in my projects, I had this idea of making my own build automation tool like Make.
I originally wanted to use Makefile-like syntax for the config file but instead settled with TOML after thinking about it for a while. I also used Rust to write this since I am kinda familiar with the language.
Rust has a TOML crate for parsing TOML files."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://rv178.is-a.dev/posts/"},{"@type":"ListItem","position":3,"name":"Writing a Build Automation Tool","item":"https://rv178.is-a.dev/posts/writing-a-build-automation-tool/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Writing a Build Automation Tool","name":"Writing a Build Automation Tool","description":"After using GNU Make for automating the build step in my projects, I had this idea of making my own build automation tool like Make.\nI originally wanted to use Makefile-like syntax for the config file but instead settled with TOML after thinking about it for a while. I also used Rust to write this since I am kinda familiar with the language.\nRust has a TOML crate for parsing TOML files.","keywords":["rust","automation","GNU make"],"articleBody":" After using GNU Make for automating the build step in my projects, I had this idea of making my own build automation tool like Make.\nI originally wanted to use Makefile-like syntax for the config file but instead settled with TOML after thinking about it for a while. I also used Rust to write this since I am kinda familiar with the language.\nRust has a TOML crate for parsing TOML files. It also provides support for deserialization and serialization using serde.\nIt’s also extremely easy to use:\n#[derive(Debug, Deserialize)] struct Recipe { build: Build, custom: Option\u003cVec\u003cCustom\u003e\u003e, pre: Option\u003cVec\u003cPre\u003e\u003e, } /* */ let recipe: Recipe; match toml::from_str(\u0026recipe_str) { Ok(r) =\u003e recipe = r, Err(e) =\u003e { printb!(\"Error: {}\", e); exit(1); } } I didn’t include the other structs to make the snippet smaller. This was also the first time I used rust macros in a project, as you can see with the printb! macro. All it does is print Baker: as coloured output.\n#[macro_export] macro_rules! printb { ($($arg:tt)*) =\u003e { println!(\"\\x1b[32mBaker:\\x1b[0m {}\", format!($($arg)*)); }; } Configuring baker The configuration file is put in the root directory of the project, just like the Makefile. If Baker is unable to find a config file (called recipe.toml), it auto generates one. For example, I use this config for my chess engine:\n[build] cmd = \"cargo build \u0026\u0026 cp -r ./target/debug/cranium ./bin/cranium\" [[custom]] name = \"clean\" cmd = \"cargo clean\" run = false [[custom]] name = \"setup\" cmd = \"mkdir -p bin \u0026\u0026 rustup install stable \u0026\u0026 rustup default stable\" run = false [[custom]] name = \"release\" cmd = \"cargo build --release \u0026\u0026 cp -r ./target/release/cranium ./bin/cranium\" run = false [[pre]] name = \"fmt\" cmd = \"cargo fmt\" Baker is invoked using bake and by default checks for the build field in the recipe.toml. The cmd value is then executed during build.\nYou can also add custom fields using custom. It also checks for a run value that is used to check whether the command should be run after build or not. So if run = true, then the command is run after build.\nBaker also checks for an optional pre field that contains commands which should be run before build. Like for example, if you wish to format your code or something before compiling.\nYou may have noticed a name value in the custom and pre fields. This is used to identify each field, and for the custom field, the name is set as an argument when Baker is invoked.\nFor example, if I have a custom field called setup:\n[[custom]] name = \"setup\" cmd = \"mkdir -p bin \u0026\u0026 rustup install stable \u0026\u0026 rustup default stable\" run = false You can run bake setup to directly execute the command inside the field.\nI accidentally discovered that Baker also supports recursion, ie. invoking baker inside baker.\nBaker is open source and you can find the repo here. I wrote it in like 2 days, so it may have bugs which I was not able to find, so all suggestions are welcome!\nHere’s a screenshot of Baker in action:\nThat’s it for this blog, see you soon!\n","wordCount":"530","inLanguage":"en","datePublished":"2022-07-08T15:20:06+05:30","dateModified":"2022-07-08T15:20:06+05:30","mainEntityOfPage":{"@type":"WebPage","@id":"https://rv178.is-a.dev/posts/writing-a-build-automation-tool/"},"publisher":{"@type":"Organization","name":"rv178","logo":{"@type":"ImageObject","url":"https://media.discordapp.net/attachments/765524394017292309/858181434085867570/1624676782371.png"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><ul id=menu><li><a href=https://rv178.is-a.dev/ title=Home><span>Home</span></a></li><li><a href=https://rv178.is-a.dev/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://rv178.is-a.dev/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul><div class=logo><a href=https://rv178.is-a.dev accesskey=h title="  (Alt + H)"></a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://rv178.is-a.dev>Home</a>&nbsp;»&nbsp;<a href=https://rv178.is-a.dev/posts/>Posts</a></div><h1 class=post-title>Writing a Build Automation Tool</h1><div class=post-meta><span title='2022-07-08 15:20:06 +0530 +0530'>July 8, 2022</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;530 words</div></header><div class=post-content><hr><p>After using GNU Make for automating the build step in my projects, I had this idea of making my own build automation tool like Make.</p><p>I originally wanted to use Makefile-like syntax for the config file but instead settled with <a href=https://toml.io>TOML</a> after thinking about it for a while.
I also used Rust to write this since I am kinda familiar with the language.</p><p>Rust has a <a href=https://docs.rs/toml/latest/toml/>TOML crate</a> for parsing TOML files.
It also provides support for deserialization and serialization using <a href=https://docs.rs/serde/latest/serde/>serde</a>.</p><p>It&rsquo;s also extremely easy to use:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>#[derive(Debug, Deserialize)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Recipe</span> {
</span></span><span style=display:flex><span>    build: <span style=color:#a6e22e>Build</span>,
</span></span><span style=display:flex><span>    custom: Option<span style=color:#f92672>&lt;</span>Vec<span style=color:#f92672>&lt;</span>Custom<span style=color:#f92672>&gt;&gt;</span>,
</span></span><span style=display:flex><span>    pre: Option<span style=color:#f92672>&lt;</span>Vec<span style=color:#f92672>&lt;</span>Pre<span style=color:#f92672>&gt;&gt;</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* &lt;the build, custom and pre structs&gt; */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> recipe: <span style=color:#a6e22e>Recipe</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>match</span> toml::from_str(<span style=color:#f92672>&amp;</span>recipe_str) {
</span></span><span style=display:flex><span>    Ok(r) <span style=color:#f92672>=&gt;</span> recipe <span style=color:#f92672>=</span> r,
</span></span><span style=display:flex><span>    Err(e) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        printb<span style=color:#f92672>!</span>(<span style=color:#e6db74>&#34;Error: {}&#34;</span>, e);
</span></span><span style=display:flex><span>        exit(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I didn&rsquo;t include the other structs to make the snippet smaller. This was also the first time I used rust macros in a project, as you can see with the <code>printb!</code> macro. All it does is print
<code>Baker: &lt;message></code> as coloured output.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>#[macro_export]</span>
</span></span><span style=display:flex><span>macro_rules! printb {
</span></span><span style=display:flex><span>    (<span style=color:#75715e>$($arg</span>:<span style=color:#a6e22e>tt</span>)<span style=color:#f92672>*</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        println!(<span style=color:#e6db74>&#34;\x1b[32mBaker:\x1b[0m {}&#34;</span>, format!(<span style=color:#75715e>$($arg</span>)<span style=color:#f92672>*</span>));
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=configuring-baker>Configuring baker<a hidden class=anchor aria-hidden=true href=#configuring-baker>#</a></h3><p>The configuration file is put in the root directory of the project, just like the Makefile.
If Baker is unable to find a config file (called <code>recipe.toml</code>), it auto generates one.
For example, I use this config for my chess engine:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>build</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>cmd</span> = <span style=color:#e6db74>&#34;cargo build &amp;&amp; cp -r ./target/debug/cranium ./bin/cranium&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[[<span style=color:#a6e22e>custom</span>]]
</span></span><span style=display:flex><span><span style=color:#a6e22e>name</span> = <span style=color:#e6db74>&#34;clean&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>cmd</span> = <span style=color:#e6db74>&#34;cargo clean&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>run</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[[<span style=color:#a6e22e>custom</span>]]
</span></span><span style=display:flex><span><span style=color:#a6e22e>name</span> = <span style=color:#e6db74>&#34;setup&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>cmd</span> = <span style=color:#e6db74>&#34;mkdir -p bin &amp;&amp; rustup install stable &amp;&amp; rustup default stable&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>run</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[[<span style=color:#a6e22e>custom</span>]]
</span></span><span style=display:flex><span><span style=color:#a6e22e>name</span> = <span style=color:#e6db74>&#34;release&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>cmd</span> = <span style=color:#e6db74>&#34;cargo build --release &amp;&amp; cp -r ./target/release/cranium ./bin/cranium&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>run</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[[<span style=color:#a6e22e>pre</span>]]
</span></span><span style=display:flex><span><span style=color:#a6e22e>name</span> = <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>cmd</span> = <span style=color:#e6db74>&#34;cargo fmt&#34;</span>
</span></span></code></pre></div><p>Baker is invoked using <code>bake</code> and by default checks for the <code>build</code> field in the <code>recipe.toml</code>.
The <code>cmd</code> value is then executed during build.</p><p>You can also add custom fields using <code>custom</code>. It also checks for a <code>run</code> value that is used to check whether the command should be run
after build or not. So if <code>run = true</code>, then the command is run after build.</p><p>Baker also checks for an optional <code>pre</code> field that contains commands which should be run <strong>before</strong> build. Like for example, if you wish to
format your code or something before compiling.</p><p>You may have noticed a <code>name</code> value in the <code>custom</code> and <code>pre</code> fields. This is used to identify each field, and for the <code>custom</code> field,
the <code>name</code> is set as an argument when Baker is invoked.</p><p>For example, if I have a <code>custom</code> field called <code>setup</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[[<span style=color:#a6e22e>custom</span>]]
</span></span><span style=display:flex><span><span style=color:#a6e22e>name</span> = <span style=color:#e6db74>&#34;setup&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>cmd</span> = <span style=color:#e6db74>&#34;mkdir -p bin &amp;&amp; rustup install stable &amp;&amp; rustup default stable&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>run</span> = <span style=color:#66d9ef>false</span>
</span></span></code></pre></div><p>You can run <code>bake setup</code> to directly execute the command inside the field.</p><p>I accidentally discovered that Baker also supports <a href=https://www.gnu.org/software/make/manual/html_node/Recursion.html>recursion</a>, ie. invoking baker inside baker.</p><p>Baker is open source and you can find the repo <a href=https://github.com/rv178/baker>here</a>.
I wrote it in like 2 days, so it may have bugs which I was not able to find, so all suggestions are welcome!</p><p>Here&rsquo;s a screenshot of Baker in action:</p><p><img loading=lazy src=https://media.discordapp.net/attachments/985433521084563486/994926621226172467/unknown.png alt=Alt></p><p>That&rsquo;s it for this blog, see you soon!</p><hr></div><footer class=post-footer><ul class=post-tags><li><a href=https://rv178.is-a.dev/tags/rust/>rust</a></li><li><a href=https://rv178.is-a.dev/tags/automation/>automation</a></li><li><a href=https://rv178.is-a.dev/tags/gnu-make/>GNU make</a></li></ul><nav class=paginav><a class=next href=https://rv178.is-a.dev/posts/fen-string-parsing-in-rust/><span class=title>Next »</span><br><span>FEN String Parsing in Rust</span></a></nav></footer></article></main><footer class=footer><span>Copyright &copy; 2022 <a href=https://rv178.is-a.dev>rv178</a></span>
<span>| <a href=https://github.com/rv178/blog-site/ rel=noopener target=_blank>Source code</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>